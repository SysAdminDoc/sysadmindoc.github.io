<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
   <title>DualShock Calibration Tool</title>
   <link rel="icon" type="image/x-icon" href="./favicon.ico">

   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

   <link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/fontawesome.min.css"
      integrity="sha384-BY+fdrpOd3gfeRvTSMT+VUZmA728cfF9Z2G42xpaRkUGu2i3DyzpTURDo5A6CaLK" crossorigin="anonymous">

   <script src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

   <script src="./gamepad-calibrate.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"></script>
</head>

<body>

   <div class="container p-2">

      <div id="missinghid" style="display: none;">
         <p class="ds-i18n">Unsupported browser. Please use a web browser with WebHID support (e.g. Chrome).</p>
      </div>

      <div id="offlinebar" class="vstack p-2" style="display: none;">
         <p class="ds-i18n">Connect a DualShock 4/DualSense controller via USB cable and press Connect.</p>
         <button id="btnconnect" type="button" class="btn btn-outline-primary ds-i18n" onclick="connect()">Connect</button><br>
         <p class="ds-i18n">* If <b>DS4Windows</b> is running, <b>turn off</b> it!</p>
      </div>

      <div id="onlinebar" class="vstack p-2" style="display: none;">
         <div class="hstack gap-2">
            <p><b class="ds-i18n">Connected to:</b></p>
            <p id="devname"></p>
         </div>
         <button type="button" class="btn btn-outline-secondary ds-i18n" onclick="disconnect()">Disconnect</button><br>
      </div>

      <div id="mainmenu" class="container" style="display: none;">
         <div class="row">
            <div class="col-md-6 col-sm-12">
               <div class="card text-bg-light">
                  <div class="card-header ds-i18n">Firmware Info</div>
                  <div class="vstack p-2" id="fwinfo"> </div>
               </div>
               <br>
            </div>

            <div class="col-md-6 col-sm-12" style="min-width: 330px;">
               <div class="vstack gap-2 p-2">
                  <button id="btnmcs2" type="button" class="btn btn-primary ds-btn ds-i18n" onclick="calib_open()">Calibrate stick center</button>
                  <div class="hstack gap-2">
                     <!-- <button type="button" class="btn btn-primary ds-btn ds-i18n" onclick="calibrateController(, true)">Calibrate stick range (permanent)</button>
                     <button type="button" class="ms-auto btn btn-primary ds-btn ds-i18n" onclick="calibrateController(, false)">Calibrate stick range (temporary)</button> -->
                     <button type="button" class="btn btn-primary ds-btn ds-i18n" onclick="multi_calibrate_range(true)">Calibrate stick range (permanent)</button>
                     <button type="button" class="ms-auto btn btn-primary ds-btn ds-i18n"  onclick="multi_calibrate_range(false)">Calibrate stick range (temporary)</button>
                  </div>
                  <button type="button" class="btn btn-danger ds-btn ds-i18n" onclick="multi_reset()" id="resetBtn">Reset controller</button>

                  <div class="card text-bg-light">
                     <div class="card-header ds-i18n">Joystick Info</div>
                     <div class="vstack px-2">
                        <center>
                           <canvas id="stickCanvas" width="300" height="150"></canvas>
                        </center>
                     </div>
                     <div class="px-2">
                        <div class="hstack">
                           <div class="vstack" style="text-align: center;">
                              <span>LX:</span>
                              <pre id="lx-lbl" style="min-width: 80px;"></pre>
                           </div>

                           <div class="vstack" style="text-align: center;">
                              <span>LY:</span>
                              <pre id="ly-lbl" style="min-width: 80px;"></pre>
                           </div>

                           <div class="vstack" style="text-align: center;">
                              <span>RX:</span>
                              <pre id="rx-lbl" style="min-width: 80px;"></pre>
                           </div>

                           <div class="vstack" style="text-align: center;">
                              <span>RY:</span>
                              <pre id="ry-lbl" style="min-width: 80px;"></pre>
                           </div>
                        </div>
                     </div>
                     <div class="px-2">
                        <center>
                           <input class="form-check-input" type="checkbox" value="" id="checkCircularity">
                           <label class="form-check-label ds-i18n" for="checkCircularity">Check circularity</label>
                           <div class="hstack" id="circ-data">
                              <div class="vstack" style="text-align: center;">
                                 <span class="ds-i18n">Err R:</span>
                                 <pre id="el-lbl" style="min-width: 80px;"></pre>
                              </div>

                              <div class="vstack" style="text-align: center;">
                                 <span class="ds-i18n">Err L:</span>
                                 <pre id="er-lbl" style="min-width: 80px;"></pre>
                              </div>
                           </div>
                        </center>
                     </div>
                  </div>

               </div>
            </div>
         </div>

         <!--
         <div class="row">
            <p class="ds-i18n">Sections below are not useful, just some debug infos or manual commands</p>
         </div>
         <div class="row">
            <div class="col-md-6 col-sm-12">
               <div class="card text-bg-light">
                  <div class="card-header">Debug info</div>
                  <div class="vstack p-2">
                     <div class="hstack">
                        <p class="ds-i18n">NVS Status</p>
                        <p class="ms-auto ds-i18n" id="d-nvstatus">Unknown</p>
                     </div>
                     <div class="hstack">
                        <p class="ds-i18n">BD Addr</p>
                        <p class="ms-auto ds-i18n" id="d-bdaddr">Unknown</p>
                     </div>
                  </div>
               </div>
               <br>
            </div>

            <div class="col-md-6 col-sm-12">
               <div class="card text-bg-light">
                  <div class="card-header ds-i18n">Debug buttons</div>
                  <div class="vstack gap-2 p-2">
                     <div class="hstack gap-2">
                        <button type="button" class="btn btn-success ds-btn ds-i18n" onclick="multi_nvstatus()">Query NVS status</button>
                        <button type="button" class="btn btn-primary ds-btn ds-i18n" onclick="multi_nvsunlock()">NVS unlock</button>
                        <button type="button" class="btn btn-primary ds-btn ds-i18n" onclick="multi_nvslock()">NVS lock</button>
                     </div>
                     <button type="button" class="btn btn-primary ds-btn ds-i18n" onclick="multi_getbdaddr()">Get BDAddr</button>
                     <button id="btnmcs" type="button" class="btn btn-primary ds-btn ds-i18n" onclick="multi_calibrate_sticks()">Fast calibrate stick center (OLD)</button>
                  </div>
               </div>
            </div>
         </div>
         -->

      </div>

      <!-- New calibrate modal -->
      <div class="modal fade" id="calibCenterModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="calibTitle" aria-hidden="true">
         <div class="modal-dialog modal-lg">
            <div class="modal-content">
               <div class="modal-header">
                  <h1 class="modal-title fs-5 ds-i18n" id="calibTitle">Stick center calibration</h1>
                  <button type="button" id="calibCross" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
               </div>
               <div class="modal-body">

                  <div class="row">
                     <div class="col-4">
                        <div class="list-group" id="list-tab">
                           <a class="ds-i18n list-group-item list-group-item-action active" id="list-1-calib">Welcome</a>
                           <a class="ds-i18n list-group-item list-group-item-action" id="list-2-calib">Step 1</a>
                           <a class="ds-i18n list-group-item list-group-item-action" id="list-3-calib">Step 2</a>
                           <a class="ds-i18n list-group-item list-group-item-action" id="list-4-calib">Step 3</a>
                           <a class="ds-i18n list-group-item list-group-item-action" id="list-5-calib">Step 4</a>
                           <a class="ds-i18n list-group-item list-group-item-action" id="list-6-calib">Completed</a>
                        </div>
                     </div>
                     <div class="col-8">
                        <div class="container" id="list-1">
                           <h4 class="ds-i18n">Welcome to the stick center-calibration wizard!</h4>

                           <p class="ds-i18n">This tool will guide you in re-centering the analog sticks of your
                              controller. It consists in four steps: you will be asked to move both sticks in a
                              direction and release them.</p>

                           <p class="ds-i18n">Please be aware that, <i>once the calibration is running, it cannot be
                                 canceled</i>. Do not close this page or disconnect your controller until is completed.
                           </p>

                           <h5 class="ds-i18n">Calibration storage</h5>

                           <p class="ds-i18n">By default the calibration is only saved in a volatile storage, so that if
                              you (or this tool) mess something up, a reset of the controller is enough to make it work
                              again.</p>

                           <p class="ds-i18n">If you wish to store the calibration permanently in the controller, tick
                              the checkbox below:</p>

                           <input class="form-check-input" type="checkbox" value="" id="calibPermanentChanges">
                           <label class="form-check-label ds-i18n" for="calibPermanentChanges">Write changes permanently
                              in the controller</label>

                           <br>

                           <p class="ds-i18n"><small>Warning: <font color="red">Do not store the calibration permanently
                                    if the controller battery is low or disconnected. It will damage your controller.
                                 </font></small></p>

                           <p class="ds-i18n">Press <b>Start</b> to begin calibration.</p>

                        </div>
                        <div class="container" style="display: none;" id="list-2">
                           <p class="ds-i18n">Please move both sticks to the <b>top-left corner</b> and release them.</p>
                           <p class="ds-i18n">When the sticks are back in the center, press <b>Continue</b>.</p>
                        </div>
                        <div class="container" style="display: none;" id="list-3">
                           <p class="ds-i18n">Please move both sticks to the <b>top-right corner</b> and release them.</p>
                           <p class="ds-i18n">When the sticks are back in the center, press <b>Continue</b>.</p>
                        </div>
                        <div class="container" style="display: none;" id="list-4">
                           <p class="ds-i18n">Please move both sticks to the <b>bottom-left corner</b> and release them.</p>
                           <p class="ds-i18n">When the sticks are back in the center, press <b>Continue</b>.</p>
                        </div>
                        <div class="container" style="display: none;" id="list-5">
                           <p class="ds-i18n">Please move both sticks to the <b>bottom-right corner</b> and release them.</p>
                           <p class="ds-i18n">When the sticks are back in the center, press <b>Continue</b>.</p>
                        </div>
                        <div class="container" style="display: none;" id="list-6">
                           <p class="ds-i18n">Calibration completed successfully!</p>
                           <p><span class="ds-i18n">You can check the calibration with the</span> <a href="https://hardwaretester.com/gamepad" target="_blank">gamepad tester</a>.</p>
                           <p class="ds-i18n">Have a nice day :)</p>
                        </div>
                     </div>
                  </div>

               </div>
               <div class="modal-footer">
                  <button type="button" class="btn btn-primary" id="calibNext" onclick="calib_next()">
                     <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" id="btnSpinner" style="display: none;"></span>
                     <span id="calibNextText" class="ds-i18n">Next</span>
                  </button>
               </div>
            </div>
         </div>
      </div>


      <!-- Modal -->
      <div class="modal fade" id="calibrateModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
         <div class="modal-dialog">
            <div class="modal-content">
               <div class="modal-header">
                  <h1 class="modal-title fs-5" id="staticBackdropLabel">Calibrating center</h1>
               </div>
               <div class="modal-body">
                  <p class="ds-i18n">Recentering the controller sticks. </p>
                  <p class="ds-i18n">Please do not close this window and do not disconnect your controller. </p>
                  <div class="progress" role="progressbar" aria-label="Centering" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                     <div class="progress-bar" style="width: 0%"></div>
                  </div>
               </div>
               <div class="modal-footer">
               </div>
            </div>
         </div>
      </div>

      <!-- Modal -->
      <div class="modal fade" id="rangeModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
         <div class="modal-dialog">
            <div class="modal-content">
               <div class="modal-header">
                  <h1 class="modal-title fs-5 ds-i18n" id="staticBackdropLabel">Range calibration</h1>
               </div>
               <div class="modal-body">
                  <p class="ds-i18n"><b>The controller is now sampling data!</b></p>
                  <p class="ds-i18n">Rotate the sticks slowly to cover the whole range. Press "Done" when completed.</p>
               </div>
               <div class="modal-footer">
                  <button type="button" class="btn btn-primary ds-i18n" onclick="multi_calibrate_range_on_close()">Done</button>
               </div>
            </div>
         </div>
      </div>

      <!-- Popup -->
      <div class="modal fade" id="popupModal" tabindex="-1" aria-labelledby="popupTitle" aria-hidden="true">
         <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
               <div class="modal-body" id="popupBody"></div>
               <div class="modal-footer">
                  <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
               </div>
            </div>
         </div>
      </div>
      
   <script src="./stick-circularity.js"></script>

</body>

</html>
